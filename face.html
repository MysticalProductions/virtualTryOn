<!doctype html>
<html>
    <head>
        <title>Glasses Try-On</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            body {
                margin: 0;
                overflow: hidden;
                background: black;
            }

            canvas {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
            }

            #webarCanvas {
                z-index: 1;
            }
            #threeCanvas {
                z-index: 2;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <canvas id="webarCanvas"></canvas>
        <canvas id="threeCanvas"></canvas>

        <script src="libs/WebARRocksFace.js"></script>

        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
                    "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
                }
            }
        </script>

        <script type="module">
            import * as THREE from "three";
            import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

            let scene, camera, renderer, glasses;

            initThree();
            initFace();
            animate();

            /* ---------- THREE ---------- */
            function initThree() {
                const canvas = document.getElementById("threeCanvas");

                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(
                    40,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    100,
                );
                camera.position.z = 5;

                renderer = new THREE.WebGLRenderer({
                    canvas,
                    alpha: true,
                    antialias: true,
                });
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight, false);

                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(0, 1, 2);
                scene.add(light);

                const loader = new GLTFLoader();
                loader.load("models/glasses.glb", (gltf) => {
                    glasses = gltf.scene;
                    scene.add(glasses);
                });

                window.addEventListener("resize", onResize);
            }

            function onResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight, false);
            }

            /* ---------- WEBAR ---------- */
            function initFace() {
                const FaceTracker = window.WEBARROCKSFACE;

                FaceTracker.init({
                    canvasId: "webarCanvas",
                    isDisplayVideo: true,
                    isMirror: true,

                    callbackReady: () => {
                        const c = document.getElementById("webarCanvas");
                        c.width = window.innerWidth;
                        c.height = window.innerHeight;
                        console.log("Camera should now be visible");
                    },

                    callbackTrack: (state) => {
                        if (!glasses || !state.isDetected) return;

                        glasses.position.set(state.x * 2, state.y * 2, -2);
                        glasses.rotation.set(state.rx, state.ry, state.rz);
                        glasses.scale.setScalar(state.s * 2);
                    },
                });
            }

            /* ---------- LOOP ---------- */
            function animate() {
                requestAnimationFrame(animate);
                if (renderer) renderer.render(scene, camera);
            }
        </script>
    </body>
</html>
