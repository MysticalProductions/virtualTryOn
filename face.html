<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no"
        />
        <title>Eyewear Try-On</title>

        <!-- THREE (GLOBAL BUILD) -->
        <script src="https://unpkg.com/three@0.136.0/build/three.min.js"></script>
        <script src="https://unpkg.com/three@0.136.0/examples/js/loaders/GLTFLoader.js"></script>

        <!-- WEBAR CORE -->
        <script src="./libs/WebARRocksFace.js"></script>

        <!-- WEBAR HELPERS -->
        <script src="./helpers/WebARRocksFaceThreeHelper.js"></script>
        <script src="./helpers/WebARRocksMirror.js"></script>
        <script src="./helpers/landmarksStabilizers/OneEuroLMStabilizer.js"></script>

        <!-- SHARED PRODUCT DATA -->
        <script src="js/products.js"></script>

        <style>
            body {
                margin: 0;
                background: black;
                overflow: hidden;
                font-family:
                    Inter,
                    system-ui,
                    -apple-system,
                    sans-serif;
                color: white;
            }

            /* CANVASES */
            #WebARRocksFaceCanvas,
            #threeCanvas {
                position: fixed;
                inset: 0;
                width: 100vw;
                height: 100vh;
            }

            #WebARRocksFaceCanvas {
                z-index: 0;
            }
            #threeCanvas {
                z-index: 1;
                pointer-events: none;
            }

            /* TOP BAR */
            .topbar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 56px;
                display: flex;
                align-items: center;
                padding: 0 16px;
                z-index: 5;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(10px);
            }

            .back {
                cursor: pointer;
                font-size: 14px;
                color: #ccc;
            }

            .brand {
                margin: auto;
                font-weight: 600;
                letter-spacing: 0.5px;
            }

            /* PRODUCT PANEL */
            .panel {
                position: fixed;
                top: 72px;
                right: 16px;
                width: 320px;
                z-index: 5;
                padding: 18px;
                background: rgba(15, 17, 21, 0.92);
                backdrop-filter: blur(14px);
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.08);
            }

            .title {
                font-size: 20px;
                margin-bottom: 4px;
            }

            .price {
                font-size: 18px;
                color: #4f8cff;
                margin-bottom: 8px;
            }

            .desc {
                font-size: 13px;
                color: #aaa;
                margin-bottom: 14px;
            }

            .switcher {
                display: flex;
                gap: 10px;
                margin-bottom: 14px;
            }

            .switcher button {
                flex: 1;
                padding: 10px;
                border-radius: 10px;
                border: none;
                cursor: pointer;
                background: #2a2f3f;
                color: white;
                font-size: 13px;
            }

            .switcher button.active {
                background: #4f8cff;
            }

            .cta {
                width: 100%;
                padding: 14px;
                border-radius: 12px;
                border: none;
                font-size: 15px;
                background: #4f8cff;
                color: white;
                cursor: pointer;
            }

            /* MOBILE */
            @media (max-width: 768px) {
                .panel {
                    top: 64px;
                    left: 50%;
                    right: auto;
                    transform: translateX(-50%);
                    width: calc(100% - 32px);
                    max-width: 420px;
                }
            }
        </style>
    </head>

    <body>
        <!-- CANVASES -->
        <canvas id="WebARRocksFaceCanvas"></canvas>
        <canvas id="threeCanvas"></canvas>

        <!-- TOP BAR -->
        <div class="topbar">
            <div class="brand">VisionXR</div>
        </div>

        <!-- PRODUCT PANEL -->
        <div class="panel">
            <div class="title" id="title"></div>
        </div>

        <script>
            let currentProduct;
            let DPR = Math.min(window.devicePixelRatio || 1, 2);
            let isInitialized = false;

            /* -------------------------
           PRODUCT HELPERS
        -------------------------- */

            function getSelectedProduct() {
                const params = new URLSearchParams(window.location.search);
                const id = parseInt(params.get("product"), 10);
                return PRODUCTS[id] || Object.values(PRODUCTS)[0];
            }

            function updateUI(p) {
                document.getElementById("title").innerText = p.name;
            }

            /* -------------------------
           AR INIT (ONCE)
        -------------------------- */

            function initMirror(modelURL) {
                if (isInitialized) return;

                WebARRocksMirror.init({
                    canvasFace: document.getElementById("WebARRocksFaceCanvas"),
                    canvasThree: document.getElementById("threeCanvas"),

                    specWebARRocksFace: {
                        NNCPath: "./neuralNetsFace/NN_GLASSES_9.json",
                        maxFacesDetected: 1,

                        // ðŸ§  MAXIMUM STABILITY CONFIG
                        landmarksStabilizerSpec: {
                            stabilizer: WebARRocksLMStabilizer,
                            smoothFactor: 0.97,
                            minCutOff: 0.0004,
                            beta: 0.4,
                            frequency: 60,
                        },
                    },

                    modelURL,
                    occluderURL: false,

                    // Small forward offset reduces depth jitter
                    translationOffset: [0, 0, 0.02],

                    width: window.innerWidth * DPR,
                    height: window.innerHeight * DPR,
                });

                isInitialized = true;
            }

            /* -------------------------
           MAIN
        -------------------------- */

            function main() {
                currentProduct = getSelectedProduct();
                updateUI(currentProduct);

                initMirror(currentProduct.model);

                window.addEventListener("resize", () => {
                    DPR = Math.min(window.devicePixelRatio || 1, 2);
                    WebARRocksMirror.resize(
                        window.innerWidth * DPR,
                        window.innerHeight * DPR,
                    );
                });
            }

            function goBack() {
                window.history.back();
            }

            window.addEventListener("load", main);
        </script>
    </body>
</html>
