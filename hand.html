<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no"
        />
        <title>VisionXR - Watch Try-On</title>

        <script src="https://cdn.jsdelivr.net/npm/three@0.136.0/build/three.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.136.0/examples/js/loaders/GLTFLoader.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.136.0/examples/js/loaders/RGBELoader.js"></script>

        <script src="libs/WebARRocksHand.js"></script>
        <script src="./helpers/HandTrackerThreeHelper.js"></script>
        <script src="./helpers/PoseFlipFilter.js"></script>
        <script src="./helpers/landmarksStabilizers/OneEuroLMStabilizer.js"></script>
        <script src="js/products.js"></script>

        <style>
            body {
                margin: 0;
                overflow: hidden;
                background: #333;
                font-family: "Inter", sans-serif;
                color: white;
            }
            #canvases {
                position: fixed;
                inset: 0;
            }
            canvas {
                position: absolute;
                top: 0;
                left: 50%;
                height: 100vh;
                transform: translate(-50%, 0%) rotateY(180deg);
            }
            #handTrackerCanvas {
                z-index: 1;
            }
            #VTOCanvas {
                z-index: 2;
            }
            .topbar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 56px;
                display: flex;
                align-items: center;
                padding: 0 16px;
                z-index: 5;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(10px);
            }
            .instructions {
                position: fixed;
                inset: 0;
                z-index: 6;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
            }
        </style>
    </head>

    <body>
        <div class="topbar">
            <div class="back" onclick="history.back()" style="cursor: pointer">
                ‚Üê Back
            </div>
            <div class="brand" style="margin: auto">VisionXR</div>
        </div>

        <div id="instructions" class="instructions">
            <div>
                Place your hand as shown:<br />
                <img
                    src="./assets/VTOWristGuidline2.png"
                    style="max-width: 240px; margin-top: 16px"
                /><br />
                <button
                    onclick="hideInstructions()"
                    style="margin-top: 20px; padding: 10px 20px"
                >
                    OK
                </button>
            </div>
        </div>

        <div id="canvases">
            <canvas id="handTrackerCanvas"></canvas>
            <canvas id="VTOCanvas"></canvas>
        </div>

        <script>
            const _settings = {
                threshold: 0.97,
                modelScale: 1.2 * 1.462,
                modelOffset: [0, 0, 0],
                modelQuaternion: [0, 0, 0, 1],

                // Occluder settings from main.js
                occluderRadiusRange: [4, 4.7],
                occluderHeight: 48,
                occluderOffset: [0, 0, 0],
                occluderQuaternion: [0.707, 0, 0, 0.707],
                occluderFlattenCoeff: 0.6,

                stabilizerOptions: {
                    minCutOff: 0.001,
                    beta: 4,
                    freqRange: [2, 144],
                    forceFilterNNInputPxRange: [2.5, 6],
                },
            };

            let currentProduct;
            let _isInstructionsHidden = false;

            function hideInstructions() {
                const inst = document.getElementById("instructions");
                if (inst) {
                    inst.style.opacity = 0;
                    setTimeout(() => inst.remove(), 500);
                }
                _isInstructionsHidden = true;
            }

            function size_canvas(cv) {
                const pixelRatio = window.devicePixelRatio || 1;
                cv.width = pixelRatio * window.innerWidth;
                cv.height = pixelRatio * window.innerHeight;
            }

            function main() {
                const params = new URLSearchParams(window.location.search);
                const id = parseInt(params.get("product"), 10) || 0;
                currentProduct = PRODUCTS[id];

                const handTrackerCanvas =
                    document.getElementById("handTrackerCanvas");
                const VTOCanvas = document.getElementById("VTOCanvas");
                size_canvas(handTrackerCanvas);
                size_canvas(VTOCanvas);

                HandTrackerThreeHelper.init({
                    landmarksStabilizerSpec: _settings.stabilizerOptions,
                    NNsPaths: ["neuralNetsHand/NN_WRISTBACK_45.json"],
                    threshold: _settings.threshold,
                    poseLandmarksLabels: [
                        "wristPinkySideBot",
                        "wristThumbSideBot",
                        "wristPinkySideTop",
                        "wristThumbSideTop",
                        "wristUpTop",
                        "wristUpBot",
                        "wristDownTop",
                        "wristDownBot",
                    ],
                    poseFilter: PoseFlipFilter.instance({}),
                    VTOCanvas: VTOCanvas,
                    handTrackerCanvas: handTrackerCanvas,
                    videoSettings: { facingMode: "user" },
                    callbackTrack: (state) => {
                        if (state.isDetected && !_isInstructionsHidden)
                            hideInstructions();
                    },
                })
                    .then(start)
                    .catch(console.error);
            }

            function start(three) {
                const pmremGenerator = new THREE.PMREMGenerator(three.renderer);
                new THREE.RGBELoader()
                    .setDataType(THREE.HalfFloatType)
                    .load("assets/hotel_room_1k.hdr", (texture) => {
                        three.scene.environment =
                            pmremGenerator.fromEquirectangular(texture).texture;
                        pmremGenerator.dispose();
                    });

                three.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                three.renderer.outputEncoding = THREE.sRGBEncoding;

                // Add Soft Occluder
                const occluderRadius = _settings.occluderRadiusRange[1];
                const occluderMesh = new THREE.Mesh(
                    new THREE.CylinderGeometry(
                        occluderRadius,
                        occluderRadius,
                        _settings.occluderHeight,
                        32,
                        1,
                        true,
                    ),
                    new THREE.MeshNormalMaterial(),
                );
                occluderMesh.position.fromArray(_settings.occluderOffset);
                occluderMesh.quaternion.fromArray(_settings.occluderQuaternion);
                occluderMesh.scale.set(
                    1.0,
                    1.0,
                    _settings.occluderFlattenCoeff,
                );

                HandTrackerThreeHelper.add_threeSoftOccluder(
                    occluderMesh,
                    occluderRadius,
                    _settings.occluderRadiusRange[1] -
                        _settings.occluderRadiusRange[0],
                    false,
                );

                loadWatchModel(three);
            }

            function loadWatchModel(three) {
                new THREE.GLTFLoader(three.loadingManager).load(
                    currentProduct.model,
                    (gltf) => {
                        const model = gltf.scene.children[0];
                        model.scale.set(1, 1, 1);

                        if (_settings.modelScale)
                            model.scale.multiplyScalar(_settings.modelScale);

                        const d = _settings.modelOffset;
                        const displacement = new THREE.Vector3(
                            d[0],
                            d[2],
                            -d[1],
                        );
                        model.position.add(displacement);

                        const q = _settings.modelQuaternion;
                        model.quaternion.set(q[0], q[2], -q[1], q[3]);

                        HandTrackerThreeHelper.add_threeObject(model);
                    },
                );
            }

            window.addEventListener("load", main);
        </script>
    </body>
</html>
